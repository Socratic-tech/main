<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>S. Clay Dr â€” Road Drag Advisor</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Serif+Display:ital@0;1&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root {
  --go:     #3E9E62;
  --wait:   #C8831A;
  --no:     #B03030;
  --ink:    #F0EBE1;
  --dim:    #8A7E6F;
  --dark:   #131110;
  --panel:  rgba(255,255,255,0.038);
  --border: rgba(240,235,225,0.09);
  --brown:  #7A5C38;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--dark);color:var(--ink);font-family:'DM Mono',monospace;min-height:100vh;overflow-x:hidden;}
body::before{content:'';position:fixed;inset:0;background-image:repeating-linear-gradient(0deg,transparent,transparent 32px,rgba(255,255,255,0.016) 32px,rgba(255,255,255,0.016) 33px);pointer-events:none;z-index:0;}

header{position:relative;z-index:2;padding:32px 32px 20px;border-bottom:1px solid var(â€“border);display:flex;justify-content:space-between;align-items:flex-end;flex-wrap:wrap;gap:12px;}
.eyebrow{font-size:9px;letter-spacing:3px;text-transform:uppercase;color:var(â€“dim);margin-bottom:8px;}
h1{font-family:â€˜Bebas Neueâ€™,sans-serif;font-size:clamp(36px,6vw,68px);letter-spacing:2px;line-height:1;}
h1 em{color:var(â€“brown);font-style:normal;}
.header-meta{font-size:10px;letter-spacing:1px;color:var(â€“dim);margin-top:6px;line-height:1.9;}
.live-badge{display:flex;align-items:center;gap:7px;font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(â€“go);border:1px solid rgba(62,158,98,0.35);padding:7px 13px;border-radius:2px;background:rgba(62,158,98,0.07);white-space:nowrap;}
.live-dot{width:6px;height:6px;border-radius:50%;background:var(â€“go);animation:blink 2s ease-in-out infinite;}
@keyframes blink{0%,100%{opacity:1}50%{opacity:0.2}}

main{position:relative;z-index:1;max-width:1060px;margin:0 auto;padding:28px 20px 80px;}

/* VERDICT CARD */
#verdictCard{border-radius:3px;padding:32px 28px;margin-bottom:28px;border:1px solid;position:relative;overflow:hidden;transition:background 0.6s,border-color 0.6s;}
#verdictCard.go  {background:rgba(62,158,98,0.09);border-color:rgba(62,158,98,0.38);}
#verdictCard.wait{background:rgba(200,131,26,0.09);border-color:rgba(200,131,26,0.38);}
#verdictCard.no  {background:rgba(176,48,48,0.09);border-color:rgba(176,48,48,0.38);}
#verdictCard.loading{background:var(â€“panel);border-color:var(â€“border);}
#verdictCard::before{content:â€™â€™;position:absolute;top:0;left:0;right:0;height:3px;transition:background 0.6s;}
#verdictCard.go::before  {background:linear-gradient(90deg,var(â€“go),transparent);}
#verdictCard.wait::before{background:linear-gradient(90deg,var(â€“wait),transparent);}
#verdictCard.no::before  {background:linear-gradient(90deg,var(â€“no),transparent);}

.verdict-row{display:flex;align-items:center;gap:18px;flex-wrap:wrap;margin-bottom:22px;}
.verdict-icon{font-size:50px;line-height:1;}
.verdict-heading{font-family:â€˜Bebas Neueâ€™,sans-serif;font-size:clamp(34px,6vw,62px);letter-spacing:3px;line-height:1;transition:color 0.4s;}
.verdict-heading.go  {color:#5DC880;}
.verdict-heading.wait{color:#E09A3A;}
.verdict-heading.no  {color:#D06060;}
.verdict-heading.loading{color:var(â€“dim);}
.verdict-reason{font-size:13px;color:var(â€“dim);margin-top:8px;line-height:1.85;max-width:560px;}

.cstrip{display:grid;grid-template-columns:repeat(5,1fr);border:1px solid var(â€“border);border-radius:3px;overflow:hidden;}
@media(max-width:640px){.cstrip{grid-template-columns:repeat(3,1fr);}}
.citem{padding:13px 16px;border-right:1px solid var(â€“border);}
.citem:last-child{border-right:none;}
.clabel{font-size:8px;letter-spacing:2px;text-transform:uppercase;color:var(â€“dim);margin-bottom:5px;display:block;}
.cval{font-family:â€˜DM Serif Displayâ€™,serif;font-size:19px;line-height:1.1;}
.csub{font-size:9px;color:var(â€“dim);margin-top:3px;}

.slabel{font-size:9px;letter-spacing:3px;text-transform:uppercase;color:var(â€“dim);margin-bottom:14px;padding-left:11px;border-left:2px solid var(â€“brown);}

/* 7-DAY */
.forecast-strip{display:grid;grid-template-columns:repeat(7,1fr);gap:7px;margin-bottom:36px;}
@media(max-width:560px){.forecast-strip{grid-template-columns:repeat(4,1fr);}}
.dcard{background:var(â€“panel);border:1px solid var(â€“border);border-radius:3px;padding:13px 7px;text-align:center;position:relative;overflow:hidden;transition:transform 0.15s;}
.dcard:hover{transform:translateY(-2px);}
.dcard.today{border-color:rgba(122,92,56,0.55);}
.dcard.today::after{content:â€˜TODAYâ€™;position:absolute;top:3px;right:4px;font-size:6px;letter-spacing:1px;color:var(â€“brown);}
.dcard-day{font-size:9px;letter-spacing:1.5px;text-transform:uppercase;color:var(â€“dim);margin-bottom:7px;}
.dcard-icon{font-size:20px;margin-bottom:6px;}
.dcard-hi{font-family:â€˜DM Serif Displayâ€™,serif;font-size:19px;line-height:1;}
.dcard-lo{font-size:10px;color:var(â€“dim);margin-top:2px;}
.dcard-pop{font-size:9px;color:#6A9CD0;margin-top:3px;}
.drag-pill{margin-top:9px;padding:3px 5px;border-radius:2px;font-size:8px;letter-spacing:1.5px;text-transform:uppercase;font-weight:500;display:inline-block;}
.drag-pill.go  {background:rgba(62,158,98,0.18);color:#5DC880;border:1px solid rgba(62,158,98,0.28);}
.drag-pill.wait{background:rgba(200,131,26,0.18);color:#E09A3A;border:1px solid rgba(200,131,26,0.28);}
.drag-pill.no  {background:rgba(176,48,48,0.18);color:#D06060;border:1px solid rgba(176,48,48,0.28);}

/* SOIL */
.soil-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:36px;}
@media(max-width:540px){.soil-grid{grid-template-columns:1fr;}}
.soil-card{background:var(â€“panel);border:1px solid var(â€“border);border-radius:3px;padding:22px;}
.soil-card h3{font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(â€“dim);margin-bottom:14px;}
.big-read{font-family:â€˜Bebas Neueâ€™,sans-serif;font-size:46px;line-height:1;margin-bottom:3px;}
.read-unit{font-size:10px;color:var(â€“dim);}
.gauge-wrap{height:6px;background:rgba(255,255,255,0.06);border-radius:3px;overflow:hidden;margin:13px 0 6px;}
.gauge-fill{height:100%;border-radius:3px;transition:width 1.2s ease;}
.gauge-labs{display:flex;justify-content:space-between;font-size:8px;color:var(â€“dim);}
.soil-note{margin-top:10px;font-size:11px;color:var(â€“dim);line-height:1.75;padding-top:10px;border-top:1px solid var(â€“border);}

/* LOADING */
.loading-pulse{display:flex;align-items:center;gap:10px;padding:20px;font-size:12px;color:var(â€“dim);letter-spacing:1px;flex-wrap:wrap;}
.spinner{width:18px;height:18px;border:2px solid rgba(255,255,255,0.1);border-top-color:var(â€“brown);border-radius:50%;animation:spin 0.8s linear infinite;flex-shrink:0;}
@keyframes spin{to{transform:rotate(360deg)}}

/* ERROR BOX */
.err-box{background:rgba(176,48,48,0.08);border:1px solid rgba(176,48,48,0.3);border-radius:3px;padding:16px 20px;margin-top:12px;font-size:11px;line-height:1.8;color:#D06060;}
.err-box strong{display:block;margin-bottom:6px;font-size:10px;letter-spacing:2px;text-transform:uppercase;}

.source-tag{font-size:9px;letter-spacing:1px;color:var(â€“dim);margin-top:10px;opacity:0.6;}

.refresh-btn{background:none;border:1px solid var(â€“border);color:var(â€“dim);padding:6px 14px;border-radius:2px;font-family:â€˜DM Monoâ€™,monospace;font-size:10px;letter-spacing:1px;cursor:pointer;margin-top:12px;transition:border-color 0.2s,color 0.2s;display:inline-block;}
.refresh-btn:hover{border-color:var(â€“brown);color:var(â€“ink);}

/* DETAILS */
details{background:var(â€“panel);border:1px solid var(â€“border);border-radius:3px;margin-bottom:12px;overflow:hidden;}
details summary{padding:15px 18px;cursor:pointer;list-style:none;font-size:11px;letter-spacing:0.5px;display:flex;justify-content:space-between;align-items:center;user-select:none;}
details summary::-webkit-details-marker{display:none;}
details summary::after{content:â€˜â–¾â€™;color:var(â€“dim);transition:transform 0.2s;}
details[open] summary::after{transform:rotate(180deg);}
.rules-body{padding:0 18px 18px;}
.rrow{display:flex;gap:11px;align-items:flex-start;padding:9px 0;border-bottom:1px solid var(â€“border);font-size:11px;line-height:1.75;color:var(â€“dim);}
.rrow:last-child{border:none;}
.rtag{font-size:8px;letter-spacing:1.5px;text-transform:uppercase;padding:3px 7px;border-radius:2px;white-space:nowrap;margin-top:2px;flex-shrink:0;}
.rtag.go  {background:rgba(62,158,98,0.18);color:#5DC880;}
.rtag.wait{background:rgba(200,131,26,0.18);color:#E09A3A;}
.rtag.no  {background:rgba(176,48,48,0.18);color:#D06060;}
.rtag.info{background:rgba(255,255,255,0.06);color:var(â€“dim);}

.shimmer{background:linear-gradient(90deg,rgba(255,255,255,0.03) 0%,rgba(255,255,255,0.07) 50%,rgba(255,255,255,0.03) 100%);background-size:200% 100%;animation:shimmer 1.6s infinite;border-radius:3px;}
@keyframes shimmer{0%{background-position:200%}100%{background-position:-200%}}

footer{text-align:center;padding:20px;z-index:1;position:relative;font-size:9px;letter-spacing:1px;color:rgba(240,235,225,0.18);border-top:1px solid var(â€“border);}
</style>

</head>
<body>

<header>
  <div>
    <div class="eyebrow">Berrien County Â· Michigan Â· Road Maintenance</div>
    <h1>S. Clay Dr<br><em>Drag Advisor</em></h1>
    <div class="header-meta">
      Watervliet, MI 49098 &nbsp;Â·&nbsp; Dirt &amp; Crushed Asphalt Surface<br>
      Live data: NWS NOAA primary Â· Open-Meteo fallback
    </div>
  </div>
  <div class="live-badge"><div class="live-dot"></div>Live Conditions</div>
</header>

<main>

  <div id="verdictCard" class="loading">
    <div class="loading-pulse"><div class="spinner"></div>Fetching live weatherâ€¦</div>
  </div>

  <div class="slabel">7-Day Drag Window Forecast</div>
  <div id="forecastStrip" class="forecast-strip">
    <div style="grid-column:1/-1;height:110px;" class="shimmer"></div>
  </div>

  <div class="slabel">Soil &amp; Ground Conditions â€” Berrien County</div>
  <div class="soil-grid">
    <div class="soil-card">
      <h3>Est. Soil Temp at 2"</h3>
      <div class="big-read" id="soilTempVal">â€”Â°</div>
      <div class="read-unit">Berrien Co. sandy loam thermal model</div>
      <div class="gauge-wrap"><div class="gauge-fill" id="soilTempGauge" style="width:0%"></div></div>
      <div class="gauge-labs"><span>Frozen 32Â°</span><span>Ideal 55Â°</span><span>90Â°</span></div>
      <div class="soil-note" id="soilTempNote">Loadingâ€¦</div>
    </div>
    <div class="soil-card">
      <h3>Estimated Frost Depth</h3>
      <div class="big-read" id="frostVal">â€”<span style="font-size:22px">"</span></div>
      <div class="read-unit">Stefan eq. Â· SW Michigan sandy loam</div>
      <div class="gauge-wrap"><div class="gauge-fill" id="frostGauge" style="width:0%"></div></div>
      <div class="gauge-labs"><span>None 0"</span><span>Caution 6"</span><span>Deep 36"</span></div>
      <div class="soil-note" id="frostNote">Loadingâ€¦</div>
    </div>
    <div class="soil-card">
      <h3>7-Day Precip Forecast</h3>
      <div class="big-read" id="precipVal">â€”<span style="font-size:22px">"</span></div>
      <div class="read-unit">est. from forecast precipitation probability</div>
      <div class="gauge-wrap"><div class="gauge-fill" id="precipGauge" style="width:0%"></div></div>
      <div class="gauge-labs"><span>Dry 0"</span><span>Caution 0.75"</span><span>Sat 2"</span></div>
      <div class="soil-note" id="precipNote">Loadingâ€¦</div>
    </div>
    <div class="soil-card">
      <h3>Seasonal Context</h3>
      <div class="big-read" style="font-size:34px;margin-bottom:6px;" id="seasonMonth">â€”</div>
      <div class="read-unit" id="seasonRec" style="font-size:11px;">â€”</div>
      <div class="soil-note" id="seasonNote">â€”</div>
    </div>
  </div>

  <div class="slabel">Field Reference</div>
  <details>
    <summary>Go / Caution / No â€” Decision Rules for S. Clay Dr</summary>
    <div class="rules-body">
      <div class="rrow"><span class="rtag go">Go</span><span>No rain in 2+ days, temps 40â€“78Â°F, soil damp but not sticky. Dust rises when a vehicle passes â€” ideal binding conditions.</span></div>
      <div class="rrow"><span class="rtag go">Go</span><span>Late May through September, 24+ hrs after light rain (&lt;0.5"). Crushed asphalt re-knits best in warm dry air.</span></div>
      <div class="rrow"><span class="rtag wait">Wait</span><span>Rain ended &lt;24 hrs ago but was light. Probe soil at 3" with a screwdriver â€” if it slides easily, wait another day.</span></div>
      <div class="rrow"><span class="rtag wait">Wait</span><span>Temps 35â€“42Â°F. Surface may be thawing but subgrade still frozen. Light pass only if urgent.</span></div>
      <div class="rrow"><span class="rtag no">No</span><span>Within 24 hrs of rain &gt;0.5", or any rain during Marchâ€“April freeze-thaw season. Ruts will harden permanently.</span></div>
      <div class="rrow"><span class="rtag no">No</span><span>Ground frozen OR puddles standing anywhere on road surface.</span></div>
      <div class="rrow"><span class="rtag no">No</span><span>After lake effect snow event (common Novâ€“Jan). Wait 12+ hrs after snowmelt completes.</span></div>
    </div>
  </details>
  <details>
    <summary>Why S. Clay Dr behaves differently than a gravel road</summary>
    <div class="rules-body">
      <div class="rrow"><span class="rtag info">Soil</span><span>Berrien County soils are sandy loam over glacial till with moderate-to-slow internal drainage. Surface dries faster than the base â€” always probe depth, not just surface feel.</span></div>
      <div class="rrow"><span class="rtag info">Hydro</span><span>Low-gradient terrain near Lake Michigan means poor lateral drainage. Water pools rather than runs off â€” extended dry windows needed after heavy rain.</span></div>
      <div class="rrow"><span class="rtag info">Winter</span><span>79" average snowfall/year. Frost depth peaks 24â€“36" in February. Marchâ€“mid-April mud season is the single highest-risk dragging period â€” avoid completely.</span></div>
      <div class="rrow"><span class="rtag info">Surface</span><span>Crushed asphalt binds when warm and slightly moist. Drag at 5â€“10Â° angle to centerline, final straight crown pass to restore drainage slope.</span></div>
    </div>
  </details>

</main>

<footer>
  Primary: NOAA NWS (api.weather.gov, grid GRR/32/65) Â· Fallback: Open-Meteo (open-meteo.com) Â· Soil: USDA SSURGO Berrien County Â· Refreshes on load
</footer>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SEASONAL BASELINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SEASON = [
  {m:"January",   score:1, verdict:"no",   rec:"Do Not Drag",               note:"Ground frozen solid. Lake effect snow frequent. Dragging strips surface material into the ditch."},
  {m:"February",  score:1, verdict:"no",   rec:"Do Not Drag",               note:"Peak frost depth 24â€“36\". Road at maximum ice saturation. Document potholes for spring."},
  {m:"March",     score:2, verdict:"no",   rec:"Mud Season â€” Stay Off",     note:"Frost thaws top-down while lower layers stay frozen. Bearing capacity near zero. Ruts harden permanently."},
  {m:"April",     score:3, verdict:"wait", rec:"Caution â€” Wait for Dry Window", note:"Ground mostly thawed mid-month. Look for 3+ consecutive dry days. Best window: last 10 days of April."},
  {m:"May",       score:4, verdict:"go",   rec:"Good â€” First Spring Window", note:"Soil fully thawed. Higher rainfall avg â€” target 2+ dry days. Best for filling winter potholes."},
  {m:"June",      score:3, verdict:"wait", rec:"Watch Rainfall â€” Wettest Month", note:"Peak precipitation. Afternoon thunderstorms common. Drag mornings only on confirmed dry windows."},
  {m:"July",      score:5, verdict:"go",   rec:"Ideal â€” Best Month",        note:"Prime maintenance window. Lower humidity, warm temps cure crushed asphalt quickly."},
  {m:"August",    score:5, verdict:"go",   rec:"Ideal â€” Second Best",       note:"Slightly drier than July. High solar radiation wicks surface moisture fast."},
  {m:"September", score:4, verdict:"go",   rec:"Good â€” Last Easy Window",   note:"Excellent through first 3 weeks. Last reliable month before fall ramp-up. Prep road for winter."},
  {m:"October",   score:3, verdict:"wait", rec:"Caution â€” Closing Window",  note:"Asphalt stops binding well below ~45Â°F. Target first two weeks only."},
  {m:"November",  score:2, verdict:"no",   rec:"Avoid â€” Pre-Winter",        note:"Temps near freezing overnight. Lake effect begins. Disturbing road now creates icy uneven surface."},
  {m:"December",  score:1, verdict:"no",   rec:"Do Not Drag",               note:"Ground freezing through the month. Lake effect in full swing. Snow/ice management only."}
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SCORING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function calcScore({tempF, humidity, windMph, pop, desc, monthIdx}) {
  let s = SEASON[monthIdx].score * 2;
  if      (tempF <= 28) s -= 5;
  else if (tempF <= 35) s -= 3;
  else if (tempF <= 42) s -= 1;
  else if (tempF <= 78) s += 1;
  if      (humidity > 90) s -= 2;
  else if (humidity > 75) s -= 1;
  else if (humidity < 50) s += 1;
  if (windMph > 10) s += 0.5;
  if      (pop > 70) s -= 3;
  else if (pop > 40) s -= 2;
  else if (pop > 20) s -= 1;
  const d = (desc||'').toLowerCase();
  if (d.includes('thunder')||d.includes('storm'))                        s -= 4;
  if (d.includes('rain')||d.includes('shower')||d.includes('drizzle'))   s -= 2;
  if (d.includes('snow')||d.includes('sleet')||d.includes('ice'))        s -= 5;
  if (d.includes('fog'))                                                  s -= 1;
  if (d.includes('sunny')||d.includes('clear'))                          s += 1;
  return Math.min(10, Math.max(0, Math.round(s)));
}
function toVerdict(score, monthIdx) {
  if (SEASON[monthIdx].verdict === 'no' && score < 5) return 'no';
  if (score >= 7) return 'go';
  if (score >= 4) return 'wait';
  return 'no';
}
function verdictLabel(v) { return v==='go'?'GOOD TO DRAG':v==='wait'?'WAIT â€” CHECK CONDITIONS':'DO NOT DRAG'; }
function verdictIcon(v)  { return v==='go'?'âœ…':v==='wait'?'âš ï¸':'ğŸš«'; }
function weatherEmoji(desc) {
  const d = (desc||'').toLowerCase();
  if (d.includes('thunder'))                                              return 'â›ˆï¸';
  if (d.includes('snow')||d.includes('blizzard'))                        return 'ğŸŒ¨ï¸';
  if (d.includes('sleet')||d.includes('freezing')||d.includes('ice'))    return 'ğŸ§Š';
  if (d.includes('rain')||d.includes('shower')||d.includes('drizzle'))   return 'ğŸŒ§ï¸';
  if (d.includes('fog'))                                                  return 'ğŸŒ«ï¸';
  if (d.includes('overcast')||d.includes('cloudy'))                      return 'â˜ï¸';
  if (d.includes('partly'))                                               return 'â›…';
  if (d.includes('sunny')||d.includes('clear'))                          return 'â˜€ï¸';
  if (d.includes('wind'))                                                 return 'ğŸ’¨';
  return 'ğŸŒ¤ï¸';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WMO CODE â†’ DESCRIPTION (Open-Meteo)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function wmoDesc(code) {
  if (code === 0)  return 'Clear Sky';
  if (code <= 2)   return 'Partly Cloudy';
  if (code === 3)  return 'Overcast';
  if (code <= 49)  return 'Foggy';
  if (code <= 59)  return 'Drizzle';
  if (code <= 69)  return 'Rain';
  if (code <= 79)  return 'Snow';
  if (code <= 82)  return 'Rain Showers';
  if (code <= 84)  return 'Snow Showers';
  if (code <= 99)  return 'Thunderstorm';
  return 'Cloudy';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NWS FETCH
// Hardcoded grid GRR/32/65 â€” skip /points entirely
// Obs station KBTL (Benton Harbor, ~8mi away)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function fetchFromNWS() {
  const H = { 'User-Agent': 'SCLayDrAdvisor/3.0 (socratictech.org)', 'Accept': 'application/geo+json' };

  const [fcastRes, obsRes] = await Promise.all([
    fetch('https://api.weather.gov/gridpoints/GRR/32,65/forecast', { headers: H }),
    fetch('https://api.weather.gov/stations/KBTL/observations/latest', { headers: H })
  ]);

  if (!fcastRes.ok) throw new Error(`NWS forecast returned HTTP ${fcastRes.status}`);
  if (!obsRes.ok)   throw new Error(`NWS observations returned HTTP ${obsRes.status}`);

  const fcast = await fcastRes.json();
  const obs   = (await obsRes.json()).properties;

  const tempC    = obs.temperature?.value ?? null;
  const tempF    = tempC !== null ? Math.round(tempC * 9/5 + 32) : null;
  const humidity = Math.round(obs.relativeHumidity?.value ?? 65);
  const windMph  = Math.round((obs.windSpeed?.value ?? 0) * 2.237);
  const skyDesc  = obs.textDescription || fcast.properties.periods[0]?.shortForecast || '';

  const forecast = fcast.properties.periods.map(p => ({
    dayName:       p.name,
    isDaytime:     p.isDaytime,
    tempF:         p.temperature,
    loTempF:       null, // NWS puts lo in separate night period
    shortForecast: p.shortForecast,
    pop:           p.probabilityOfPrecipitation?.value ?? 0
  }));

  return { tempF: tempF ?? 50, humidity, windMph, skyDesc, forecast, source: 'NWS' };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// OPEN-METEO FALLBACK
// Free, no auth, explicit CORS, very reliable
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function fetchFromOpenMeteo() {
  const url = 'https://api.open-meteo.com/v1/forecast'
    + '?latitude=42.7726&longitude=-86.2716'
    + '&current=temperature_2m,relative_humidity_2m,wind_speed_10m,weather_code'
    + '&daily=temperature_2m_max,temperature_2m_min,weather_code,precipitation_probability_max'
    + '&temperature_unit=fahrenheit&wind_speed_unit=mph'
    + '&timezone=America%2FDetroit&forecast_days=7';

  const res = await fetch(url);
  if (!res.ok) throw new Error(`Open-Meteo returned HTTP ${res.status}`);
  const d = await res.json();

  const cur      = d.current;
  const tempF    = Math.round(cur.temperature_2m);
  const humidity = Math.round(cur.relative_humidity_2m);
  const windMph  = Math.round(cur.wind_speed_10m);
  const skyDesc  = wmoDesc(cur.weather_code);

  const DAY = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
  const forecast = d.daily.time.map((dateStr, i) => {
    const dow = new Date(dateStr + 'T12:00:00').getDay();
    return {
      dayName:       i === 0 ? 'Today' : DAY[dow],
      isDaytime:     true,
      tempF:         Math.round(d.daily.temperature_2m_max[i]),
      loTempF:       Math.round(d.daily.temperature_2m_min[i]),
      shortForecast: wmoDesc(d.daily.weather_code[i]),
      pop:           d.daily.precipitation_probability_max[i] ?? 0
    };
  });

  return { tempF, humidity, windMph, skyDesc, forecast, source: 'Open-Meteo' };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAIN FETCH â€” NWS â†’ Open-Meteo â†’ throw
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function fetchWeather() {
  let nwsError = null;

  try {
    return await fetchFromNWS();
  } catch(e) {
    nwsError = e.message;
    console.warn('NWS failed:', nwsError);
    setStatus(`NWS unavailable (${nwsError}) â€” trying Open-Meteo backupâ€¦`);
  }

  try {
    return await fetchFromOpenMeteo();
  } catch(e) {
    throw new Error(`Both sources failed.\nNWS: ${nwsError}\nOpen-Meteo: ${e.message}`);
  }
}

function setStatus(msg) {
  const card = document.getElementById('verdictCard');
  if (card && card.classList.contains('loading')) {
    card.innerHTML = `<div class="loading-pulse"><div class="spinner"></div>${msg}</div>`;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER VERDICT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderVerdict(wx, monthIdx) {
  const dayPeriod = wx.forecast?.find(p => p.isDaytime) ?? wx.forecast?.[0];
  const pop    = dayPeriod?.pop ?? 0;
  const score  = calcScore({tempF:wx.tempF, humidity:wx.humidity, windMph:wx.windMph, pop, desc:wx.skyDesc, monthIdx});
  const verdict= toVerdict(score, monthIdx);
  const s      = SEASON[monthIdx];

  const card = document.getElementById('verdictCard');
  card.className = verdict;
  card.innerHTML = `
    <div class="verdict-row">
      <div class="verdict-icon">${verdictIcon(verdict)}</div>
      <div>
        <div class="verdict-heading ${verdict}">${verdictLabel(verdict)}</div>
        <div class="verdict-reason">${
          verdict==='go'   ? `Conditions favorable. Score ${score}/10 â€” ${wx.tempF}Â°F, ${wx.skyDesc.toLowerCase()}, ${wx.humidity}% humidity. ${s.note}` :
          verdict==='wait' ? `Conditions marginal â€” score ${score}/10. Check soil at 3" depth with a screwdriver before committing. ${s.note}` :
                             `Not recommended â€” score ${score}/10. ${s.note}`
        }</div>
      </div>
    </div>
    <div class="cstrip">
      <div class="citem"><span class="clabel">Temperature</span><div class="cval">${wx.tempF}Â°F</div><div class="csub">${wx.tempF<32?'below freezing':wx.tempF<45?'cold':wx.tempF<65?'cool':'warm'}</div></div>
      <div class="citem"><span class="clabel">Sky / Weather</span><div class="cval" style="font-size:13px;">${wx.skyDesc||'â€”'}</div><div class="csub">current</div></div>
      <div class="citem"><span class="clabel">Humidity</span><div class="cval">${wx.humidity}%</div><div class="csub">relative</div></div>
      <div class="citem"><span class="clabel">Wind</span><div class="cval">${wx.windMph} mph</div><div class="csub">drying factor</div></div>
      <div class="citem"><span class="clabel">Drag Score</span><div class="cval">${score}/10</div><div class="csub">today</div></div>
    </div>
    <div class="source-tag">Data source: ${wx.source}</div>
  `;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER 7-DAY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderForecast(forecast) {
  const strip = document.getElementById('forecastStrip');
  strip.innerHTML = '';

  const dayPeriods = forecast.filter(p => p.isDaytime).slice(0, 7);

  // For NWS: build night lookup by name
  const nightMap = {};
  forecast.filter(p => !p.isDaytime).forEach(p => {
    const key = p.dayName.toLowerCase().replace('tonight','').replace('night','').trim();
    nightMap[key] = p;
  });

  dayPeriods.forEach((p, i) => {
    const monthIdx = new Date().getMonth();
    const score  = calcScore({tempF:p.tempF, humidity:65, windMph:5, pop:p.pop||0, desc:p.shortForecast, monthIdx});
    const verdict= toVerdict(score, monthIdx);

    // Low temp: from Open-Meteo it's on the period; from NWS it's in the night period
    let lo = p.loTempF ?? null;
    if (lo === null) {
      const nk = Object.keys(nightMap).find(k => p.dayName.toLowerCase().includes(k) || k.includes(p.dayName.toLowerCase().split(' ')[0]));
      lo = nk ? nightMap[nk].tempF : null;
    }

    const card = document.createElement('div');
    card.className = `dcard${i===0?' today':''}`;
    card.innerHTML = `
      <div class="dcard-day">${i===0?'Today':p.dayName}</div>
      <div class="dcard-icon">${weatherEmoji(p.shortForecast)}</div>
      <div class="dcard-hi">${p.tempF}Â°</div>
      <div class="dcard-lo">${lo!==null?'Lo: '+lo+'Â°':'â€”'}</div>
      <div class="dcard-pop">${(p.pop||0)>0?(p.pop)+'% rain':'Dry'}</div>
      <div class="drag-pill ${verdict}">${verdict==='go'?'Drag':verdict==='wait'?'Maybe':'Skip'}</div>
    `;
    strip.appendChild(card);
  });

  // Pad to 7 if needed
  while (strip.children.length < 7) {
    const el = document.createElement('div');
    el.className = 'dcard';
    el.innerHTML = '<div class="dcard-day">â€”</div><div class="dcard-icon">â€”</div><div class="dcard-hi">â€”</div>';
    strip.appendChild(el);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER SOIL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderSoil(wx, monthIdx) {
  const seasonalAvgF = [28,30,38,48,58,67,73,72,65,54,43,32][monthIdx];
  const soilF        = Math.round(wx.tempF * 0.65 + seasonalAvgF * 0.35);

  const monthFreezeDays = [28,25,10,1,0,0,0,0,0,0,5,18];
  const freezeIndex     = monthFreezeDays[monthIdx] * Math.max(0, 32 - Math.min(wx.tempF, 32));
  const frostIn         = freezeIndex > 0 ? Math.min(36, Math.round(1.5 * Math.sqrt(freezeIndex/24))) : 0;

  const dayPeriods = wx.forecast.filter(p => p.isDaytime).slice(0,7);
  const avgPop     = dayPeriods.length ? dayPeriods.reduce((s,p)=>s+(p.pop||0),0)/dayPeriods.length : 0;
  const precipEst  = parseFloat((avgPop * 0.018).toFixed(2));

  const soilPct   = Math.min(100, Math.max(0, ((soilF-32)/58)*100));
  const soilColor = soilF<34?'var(--no)':soilF<50?'var(--wait)':soilF<80?'var(--go)':'var(--wait)';
  document.getElementById('soilTempVal').textContent   = `${soilF}Â°`;
  document.getElementById('soilTempGauge').style.width = soilPct+'%';
  document.getElementById('soilTempGauge').style.background = soilColor;
  document.getElementById('soilTempNote').textContent  =
    soilF<32 ? 'Frozen â€” no dragging.' :
    soilF<40 ? 'Cold but unfrozen. Weak bearing â€” caution only.' :
    soilF<55 ? 'Cool. Adequate if dry. Probe surface before dragging.' :
    soilF<75 ? 'Ideal range. Crushed asphalt binds well.' :
    'Warm â€” good binding. Avoid midday if air temp >90Â°F.';

  const frostPct   = Math.min(100,(frostIn/36)*100);
  const frostColor = frostIn===0?'var(--go)':frostIn<6?'var(--wait)':'var(--no)';
  document.getElementById('frostVal').innerHTML         = `${frostIn}<span style="font-size:22px">"</span>`;
  document.getElementById('frostGauge').style.width     = frostPct+'%';
  document.getElementById('frostGauge').style.background= frostColor;
  document.getElementById('frostNote').textContent      =
    frostIn===0 ? 'No frost. Subgrade not impaired.' :
    frostIn<6   ? 'Shallow frost. Surface thaw-refreeze active. Light pass only.' :
    frostIn<18  ? 'Moderate frost. Mud season risk â€” subgrade weakened.' :
    'Deep frost. Road locked. Do not drag.';

  const precipPct   = Math.min(100,(precipEst/2)*100);
  const precipColor = precipEst<0.5?'var(--go)':precipEst<1?'var(--wait)':'var(--no)';
  document.getElementById('precipVal').innerHTML         = `${precipEst.toFixed(2)}<span style="font-size:22px">"</span>`;
  document.getElementById('precipGauge').style.width     = precipPct+'%';
  document.getElementById('precipGauge').style.background= precipColor;
  document.getElementById('precipNote').textContent      =
    precipEst<0.25 ? 'Very dry period. Surface may be dusty â€” ideal.' :
    precipEst<0.5  ? 'Dry conditions. Good window if no rain in past 48 hrs.' :
    precipEst<1.0  ? 'Moderate moisture expected. Verify surface before dragging.' :
    'High precipitation forecast. Wait for 2+ dry days.';

  const s      = SEASON[monthIdx];
  const sColor = s.verdict==='go'?'#5DC880':s.verdict==='wait'?'#E09A3A':'#D06060';
  document.getElementById('seasonMonth').textContent = s.m;
  document.getElementById('seasonMonth').style.color = sColor;
  document.getElementById('seasonRec').textContent   = s.rec;
  document.getElementById('seasonRec').style.color   = sColor;
  document.getElementById('seasonNote').textContent  = s.note;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SEASONAL FALLBACK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderSeasonalFallback(errMsg) {
  const monthIdx = new Date().getMonth();
  const s = SEASON[monthIdx];
  const sColor = s.verdict==='go'?'#5DC880':s.verdict==='wait'?'#E09A3A':'#D06060';

  const card = document.getElementById('verdictCard');
  card.className = s.verdict;
  card.innerHTML = `
    <div class="verdict-row">
      <div class="verdict-icon">${verdictIcon(s.verdict)}</div>
      <div>
        <div class="verdict-heading ${s.verdict}">${verdictLabel(s.verdict)}</div>
        <div class="verdict-reason">Seasonal baseline for ${s.m} â€” live weather unavailable. ${s.note}</div>
      </div>
    </div>
    <div class="cstrip">
      <div class="citem"><span class="clabel">Temperature</span><div class="cval">â€”</div><div class="csub">offline</div></div>
      <div class="citem"><span class="clabel">Sky</span><div class="cval" style="font-size:13px;">â€”</div><div class="csub">offline</div></div>
      <div class="citem"><span class="clabel">Humidity</span><div class="cval">â€”</div><div class="csub">offline</div></div>
      <div class="citem"><span class="clabel">Wind</span><div class="cval">â€”</div><div class="csub">offline</div></div>
      <div class="citem"><span class="clabel">Drag Score</span><div class="cval">${s.score*2}/10</div><div class="csub">seasonal est.</div></div>
    </div>
    <div class="err-box">
      <strong>Error Details</strong>
      ${errMsg.replace(/\n/g,'<br>')}
    </div>
    <button class="refresh-btn" onclick="init()">â†» Retry</button>
  `;

  // 7-day seasonal
  const strip = document.getElementById('forecastStrip');
  strip.innerHTML = '';
  ['Today','Day 2','Day 3','Day 4','Day 5','Day 6','Day 7'].forEach((d,i) => {
    const el = document.createElement('div');
    el.className = `dcard${i===0?' today':''}`;
    el.innerHTML = `
      <div class="dcard-day">${d}</div>
      <div class="dcard-icon">â€”</div>
      <div class="dcard-hi">â€”</div>
      <div class="dcard-lo">offline</div>
      <div class="dcard-pop">â€”</div>
      <div class="drag-pill ${s.verdict}">${s.verdict==='go'?'Drag':s.verdict==='wait'?'Maybe':'Skip'}</div>
    `;
    strip.appendChild(el);
  });

  const seasonalAvgF = [28,30,38,48,58,67,73,72,65,54,43,32][monthIdx];
  document.getElementById('soilTempVal').textContent   = `${seasonalAvgF}Â°`;
  document.getElementById('soilTempGauge').style.width = Math.min(100,Math.max(0,((seasonalAvgF-32)/58)*100))+'%';
  document.getElementById('soilTempGauge').style.background = seasonalAvgF<40?'var(--no)':seasonalAvgF<55?'var(--wait)':'var(--go)';
  document.getElementById('soilTempNote').textContent  = `Seasonal avg for ${s.m}. ${s.note}`;
  document.getElementById('frostVal').innerHTML        = 'â€”<span style="font-size:22px">"</span>';
  document.getElementById('frostNote').textContent     = 'Retry above to load live frost depth estimate.';
  document.getElementById('precipVal').innerHTML       = 'â€”<span style="font-size:22px">"</span>';
  document.getElementById('precipNote').textContent    = 'Retry above to load live precipitation forecast.';
  document.getElementById('seasonMonth').textContent   = s.m;
  document.getElementById('seasonMonth').style.color   = sColor;
  document.getElementById('seasonRec').textContent     = s.rec;
  document.getElementById('seasonRec').style.color     = sColor;
  document.getElementById('seasonNote').textContent    = s.note;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function init() {
  const monthIdx = new Date().getMonth();
  document.getElementById('verdictCard').className = 'loading';
  document.getElementById('verdictCard').innerHTML = '<div class="loading-pulse"><div class="spinner"></div>Fetching live weatherâ€¦</div>';
  document.getElementById('forecastStrip').innerHTML = '<div style="grid-column:1/-1;height:110px;" class="shimmer"></div>';

  try {
    const wx = await fetchWeather();
    renderVerdict(wx, monthIdx);
    renderForecast(wx.forecast);
    renderSoil(wx, monthIdx);
  } catch(e) {
    console.error('All weather sources failed:', e);
    renderSeasonalFallback(e.message);
  }
}

init();
</script>

</body>
</html>